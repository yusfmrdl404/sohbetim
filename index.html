<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🔐 Güvenli Sohbet</title>
  <!-- Bildirim sesi -->
  <audio id="notificationSound" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" preload="auto"></audio>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #eaeaea;
      margin: 0;
      padding: 0;
      transition: background 0.3s;
    }
    body.dark-mode {
      background: #121212;
    }
    .container {
      max-width: 600px;
      margin: 20px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 90vh;
      transition: background 0.3s, color 0.3s;
    }
    .container.dark-mode {
      background: #1e1e1e;
      color: #e0e0e0;
    }
    header {
      background: #075e54;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .container.dark-mode header {
      background: #0d47a1;
    }
    #chatArea {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
    }
    .container.dark-mode #chatArea {
      background: #1a1a1a;
    }
    .msg {
      max-width: 70%;
      padding: 10px 14px;
      margin: 5px 0;
      border-radius: 12px 12px 0 12px;
      line-height: 1.4;
    }
    .msg-self {
      background: #075e54;
      color: white;
      align-self: flex-end;
      border-radius: 12px 12px 12px 0;
    }
    .container.dark-mode .msg-self {
      background: #0d47a1;
    }
    .msg-other {
      background: #e0e0e0;
      color: #000;
      align-self: flex-start;
    }
    .container.dark-mode .msg-other {
      background: #333;
      color: #fff;
    }
    .input-area {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
      background: white;
    }
    .container.dark-mode .input-area {
      background: #1e1e1e;
      border-top-color: #444;
    }
    #messageInput {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
    }
    .container.dark-mode #messageInput {
      border-color: #444;
      background: #333;
      color: #fff;
    }
    #sendBtn {
      margin-left: 10px;
      padding: 0 16px;
      background: #075e54;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }
    .container.dark-mode #sendBtn {
      background: #0d47a1;
    }
    .user-list-container {
      background: #f8f9fa;
      padding: 10px;
      border-bottom: 1px solid #ddd;
      height: 200px;
      overflow-y: auto;
      font-size: 14px;
    }
    .container.dark-mode .user-list-container {
      background: #2a2a2a;
      border-bottom-color: #444;
    }
    .user-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      margin: 4px 0;
      background: #f0f0f0;
      border-radius: 8px;
      cursor: pointer;
    }
    .container.dark-mode .user-item {
      background: #333;
    }
    .user-item:hover {
      background: #e0e0e0;
    }
    .container.dark-mode .user-item:hover {
      background: #444;
    }
    .user-item img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    .form {
      padding: 20px;
      text-align: center;
    }
    input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .container.dark-mode input {
      border-color: #444;
      background: #333;
      color: #fff;
    }
    button {
      padding: 10px 16px;
      background: #075e54;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .container.dark-mode button {
      background: #0d47a1;
    }
    .btn-outline {
      background: #f0f0f0;
      color: #333;
    }
    .container.dark-mode .btn-outline {
      background: #333;
      color: white;
      border: 1px solid #555;
    }
    .alert {
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
    .alert-error {
      background: #f8d7da;
      color: #721c24;
    }
    .container.dark-mode .alert-error {
      background: #444;
      color: #fff;
      border: 1px solid #555;
    }
    .alert-success {
      background: #d4edda;
      color: #155724;
    }
    .container.dark-mode .alert-success {
      background: #444;
      color: #fff;
    }
    #auth, #startChat { display: block; }
    #chatScreen { display: none; }
  </style>
</head>
<body>

  <!-- GİRİŞ EKRANI -->
  <div id="auth">
    <div class="container" style="height: auto; padding: 20px; position: relative;">
      <button onclick="toggleDarkMode()" style="position: absolute; top: 10px; right: 10px; background: #555; color: white; border: none; padding: 6px 8px; border-radius: 4px;">🌙</button>
      <h2>🔐 Giriş Yap</h2>
      <div class="alert alert-error" id="error"></div>
      <div class="alert alert-success" id="success"></div>

      <div class="form">
        <input type="email" id="loginEmail" placeholder="E-posta" />
        <input type="password" id="loginPassword" placeholder="Şifre" />
        <button onclick="login()">Giriş Yap</button>
        <p><button onclick="resetPassword()" class="btn-outline">Şifremi Unuttum</button></p>
        <p id="resendSection" style="display:none;">
          <button onclick="resendVerification()" class="btn-outline">📧 Doğrulama Maili Tekrar Gönder</button>
        </p>
        <hr>
        <h3>📝 Kayıt Ol</h3>
        <input type="email" id="registerEmail" placeholder="E-posta" />
        <input type="text" id="registerUsername" placeholder="Kullanıcı Adı (ID)" />
        <input type="password" id="registerPassword" placeholder="Şifre" />
        <button onclick="register()">Kayıt Ol</button>
      </div>
    </div>
  </div>

  <!-- SOHBET EKRANI -->
  <div id="chatScreen" style="display:none;">
    <div class="container">
      <!-- Kullanıcı Listesi -->
      <div class="user-list-container">
        <strong>👥 Kullanıcı Listesi</strong>
        <div id="userList"></div>
      </div>

      <!-- Sohbet Başlığı -->
      <header id="chatHeader">
        Sohbet: <span id="chatWithUser">Kimse seçilmedi</span>
        <button onclick="toggleDarkMode()" style="float: right; background: #555; color: white; border: none; padding: 4px 8px; border-radius: 4px;">🌙</button>
      </header>

      <!-- Mesaj Alanı -->
      <div id="chatArea"></div>

      <!-- Mesaj Gönderme -->
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Mesaj yaz..." />
        <button id="sendBtn" onclick="sendMessage()">Gönder</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase yapılandırması (KENDİ BİLGİNİ KULLAN)
    const firebaseConfig = {
      apiKey: "AIzaSyCICiMDhK5MkQDq4dbV_9jkDMt4n3MUpEg",
      authDomain: "sohbetim-9a9d7.firebaseapp.com",
      databaseURL: "https://sohbetim-9a9d7-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sohbetim-9a9d7",
      storageBucket: "sohbetim-9a9d7.firebasestorage.app",
      messagingSenderId: "277333150871",
      appId: "1:277333150871:web:d923f8cddb19ec2f672dd2"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let currentUsername = "";
    let otherUserId = "";
    const sound = document.getElementById("notificationSound");

    // Uyarı göster
    function showAlert(id, msg, type) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.style.display = "block";
      el.className = `alert alert-${type}`;
      setTimeout(() => el.style.display = "none", 5000);
    }

    // Koyu/Açık tema geçişi
    function toggleDarkMode() {
      const body = document.body;
      const isDark = body.classList.toggle('dark-mode');
      const buttons = document.querySelectorAll('button[onclick*="toggleDarkMode"]');
      buttons.forEach(b => b.innerText = isDark ? '☀️' : '🌙');
      localStorage.setItem('darkMode', isDark);
    }

    // Sayfa yüklendiğinde tema yükle
    document.addEventListener('DOMContentLoaded', () => {
      const isDark = localStorage.getItem('darkMode') === 'true';
      if (isDark) {
        document.body.classList.add('dark-mode');
        document.querySelectorAll('button[onclick*="toggleDarkMode"]').forEach(b => b.innerText = '☀️');
      }
    });

    // Oturum kontrolü
    auth.onAuthStateChanged(user => {
      if (user) {
        if (!user.emailVerified) {
          document.getElementById("auth").style.display = "block";
          document.getElementById("chatScreen").style.display = "none";
          document.getElementById("resendSection").style.display = "block";
          showAlert("error", "📧 Lütfen e-postanızı doğrulayın. Spam klasörünü kontrol edin.", "error");
          return;
        }

        currentUser = user;

        // Kullanıcı adını localStorage'dan al
        if (!localStorage.username) {
          const name = prompt("Kullanıcı adınız (ID) nedir?");
          if (name) {
            localStorage.username = name;
            currentUsername = name;
          } else {
            logout();
            return;
          }
        } else {
          currentUsername = localStorage.username;
        }

        // Sohbet ekranını göster
        document.getElementById("auth").style.display = "none";
        document.getElementById("chatScreen").style.display = "block";
        document.getElementById("resendSection").style.display = "none";

        // Online olarak işaretle
        db.ref("users/" + user.uid).update({ online: true });

        // Çıkışta offline yap
        window.addEventListener("beforeunload", () => {
          if (currentUser) {
            db.ref("users/" + currentUser.uid).update({ online: false });
          }
        });

        loadUserList();
      } else {
        document.getElementById("auth").style.display = "block";
        document.getElementById("chatScreen").style.display = "none";
        document.getElementById("resendSection").style.display = "none";
      }
    });

    // Kullanıcı listesi (KENDİNİ GÖSTERME)
    function loadUserList() {
      const usersRef = db.ref("users");
      const userList = document.getElementById("userList");
      userList.innerHTML = "<em>Yükleniyor...</em>";

      usersRef.on("value", (snapshot) => {
        userList.innerHTML = "";
        let hasUsers = false;

        snapshot.forEach((child) => {
          const userId = child.key;
          const data = child.val();

          // 🔒 KENDİNİ ATLA
          if (currentUser && userId === currentUser.uid) {
            return;
          }

          hasUsers = true;

          const username = data.username;
          const photoURL = data.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}`;
          const isOnline = data.online;

          const userItem = document.createElement("div");
          userItem.className = "user-item";
          userItem.innerHTML = `
            <img src="${photoURL}" alt="pp" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
            <div style="flex:1;">
              <strong>${username}</strong>
              <div style="font-size:12px; color: ${isOnline ? 'green' : 'gray'};">● ${isOnline ? 'Online' : 'Offline'}</div>
            </div>
          `;

          userItem.onclick = () => {
            otherUserId = userId;
            document.getElementById("chatWithUser").innerText = username;
            loadMessages();
          };

          userList.appendChild(userItem);
        });

        if (!hasUsers) {
          userList.innerHTML = "<em>Henüz başka kullanıcı yok</em>";
        }
      });
    }

    // Kayıt ol
    function register() {
      const email = document.getElementById("registerEmail").value;
      const password = document.getElementById("registerPassword").value;
      const username = document.getElementById("registerUsername").value;
      const photoURL = prompt("Profil resmin (URL) varsa gir, yoksa boş bırak", `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}`);

      if (!username) return showAlert("error", "Kullanıcı adı girin!", "error");

      auth.createUserWithEmailAndPassword(email, password)
        .then(async (userCredential) => {
          await userCredential.user.sendEmailVerification();
          localStorage.username = username;
          localStorage.photoURL = photoURL || "";

          db.ref("users/" + userCredential.user.uid).set({
            username: username,
            email: email,
            emailVerified: false,
            photoURL: photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}`,
            online: false
          });

          showAlert("success", `Kayıt başarılı! Lütfen e-postanızı doğrulayın.`, "success");
          auth.signOut();
        })
        .catch(e => showAlert("error", e.message, "error"));
    }

    // Giriş yap
    function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      if (!email || !password) return showAlert("error", "E-posta ve şifre girin.", "error");

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          if (!user.emailVerified) {
            showAlert("error", "Lütfen e-postanızı doğrulayın.", "error");
            auth.signOut();
            return;
          }

          if (!localStorage.username) {
            const name = prompt("Kullanıcı adınız (ID) nedir?");
            if (name) {
              localStorage.username = name;
              currentUsername = name;
            } else {
              logout();
              return;
            }
          }
        })
        .catch(e => showAlert("error", e.message, "error"));
    }

    // Şifremi unuttum
    function resetPassword() {
      const email = document.getElementById("loginEmail").value;
      if (!email) return showAlert("error", "E-posta girin.", "error");
      auth.sendPasswordResetEmail(email)
        .then(() => showAlert("success", "Şifre sıfırlama bağlantısı gönderildi.", "success"))
        .catch(e => showAlert("error", e.message, "error"));
    }

    // Doğrulama maili tekrar gönder
    function resendVerification() {
      const user = auth.currentUser;
      if (user && !user.emailVerified) {
        user.sendEmailVerification()
          .then(() => showAlert("success", "Doğrulama maili gönderildi.", "success"))
          .catch(e => showAlert("error", e.message, "error"));
      }
    }

    // Çıkış yap
    function logout() {
      if (currentUser) {
        db.ref("users/" + currentUser.uid).update({ online: false });
      }
      auth.signOut();
      localStorage.removeItem("username");
      localStorage.removeItem("photoURL");
      showAlert("success", "Çıkış yapıldı.", "success");
    }

    // Şifreleme (AES-GCM)
    async function encrypt(text) {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const key = await crypto.subtle.importKey(
        "raw",
        encoder.encode("sohbetim-gizli-anahtar-32karakter!"),
        { name: "AES-GCM" },
        false,
        ["encrypt"]
      );
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, data);
      return btoa(String.fromCharCode(...new Uint8Array(encrypted))) + "." + btoa(String.fromCharCode(...iv));
    }

    async function decrypt(encrypted) {
      try {
        const [dataB64, ivB64] = encrypted.split(".");
        const data = Uint8Array.from(atob(dataB64), c => c.charCodeAt(0));
        const iv = Uint8Array.from(atob(ivB64), c => c.charCodeAt(0));
        const key = await crypto.subtle.importKey(
          "raw",
          new TextEncoder().encode("sohbetim-gizli-anahtar-32karakter!"),
          { name: "AES-GCM" },
          false,
          ["decrypt"]
        );
        const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
        return new TextDecoder().decode(decrypted);
      } catch {
        return "[Şifreli mesaj - çözülemedi]";
      }
    }

    // Mesaj gönder
    async function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !otherUserId) return;

      const encryptedText = await encrypt(text);
      const chatKey = [currentUser.uid, otherUserId].sort().join("_");
      const chatRef = db.ref("chats/" + chatKey);

      chatRef.push({
        from: currentUsername,
        text: encryptedText,
        timestamp: Date.now(),
        encrypted: true
      });

      input.value = "";
    }

    // Mesajları yükle
    function loadMessages() {
      if (!otherUserId) return;

      const chatKey = [currentUser.uid, otherUserId].sort().join("_");
      const chatRef = db.ref("chats/" + chatKey);

      chatRef.limitToLast(50).on("value", async (snapshot) => {
        const area = document.getElementById("chatArea");
        area.innerHTML = "";

        for (let child of snapshot.entries()) {
          const data = child.val();
          let displayText = data.text;

          if (data.encrypted) {
            displayText = await decrypt(data.text);
          }

          const isSelf = data.from === currentUsername;
          const msg = document.createElement("div");
          msg.className = "msg " + (isSelf ? "msg-self" : "msg-other");
          msg.innerText = displayText;
          area.appendChild(msg);
        }

        area.scrollTop = area.scrollHeight;

        // Sadece başkasından gelen mesajda ses
        if (snapshot.size > 0 && !isSelf) {
          sound.play().catch(() => {});
        }
      });
    }

    // Enter ile mesaj gönder
    document.getElementById("messageInput")?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>
