<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Tarzı Sohbet</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #eaeaea;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 20px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 90vh;
    }
    header {
      background: #075e54;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }
    #chatArea {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
    }
    .msg {
      max-width: 70%;
      padding: 10px 14px;
      margin: 5px 0;
      border-radius: 12px 12px 0 12px;
      line-height: 1.4;
    }
    .msg-self {
      background: #075e54;
      color: white;
      align-self: flex-end;
      border-radius: 12px 12px 12px 0;
    }
    .msg-other {
      background: #e0e0e0;
      color: #000;
      align-self: flex-start;
    }
    .input-area {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
      background: white;
    }
    #messageInput {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
    }
    #sendBtn {
      margin-left: 10px;
      padding: 0 16px;
      background: #075e54;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }
    .form {
      padding: 20px;
      text-align: center;
    }
    input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    button {
      padding: 10px 16px;
      background: #075e54;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-outline {
      background: #f0f0f0;
      color: #333;
    }
    .alert {
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
    .alert-error {
      background: #f8d7da;
      color: #721c24;
    }
    .alert-success {
      background: #d4edda;
      color: #155724;
    }
    #auth, #startChat { display: block; }
    #chatScreen { display: none; }
  </style>
</head>
<body>

  <!-- GİRİŞ EKRANI -->
  <div id="auth">
    <div class="container" style="height: auto; padding: 20px;">
      <h2>🔐 Giriş Yap</h2>
      <div class="alert alert-error" id="error">Hata mesajı</div>
      <div class="alert alert-success" id="success">Başarı mesajı</div>

      <div class="form">
        <input type="email" id="loginEmail" placeholder="E-posta" />
        <input type="password" id="loginPassword" placeholder="Şifre" />
        <button onclick="login()">Giriş Yap</button>
        <p><button onclick="resetPassword()" class="btn-outline">Şifremi Unuttum</button></p>

        <hr>
        <h3>📝 Kayıt Ol</h3>
        <input type="email" id="registerEmail" placeholder="E-posta" />
        <input type="text" id="registerUsername" placeholder="Kullanıcı Adı (ID)" />
        <input type="password" id="registerPassword" placeholder="Şifre" />
        <button onclick="register()">Kayıt Ol</button>
      </div>
    </div>
  </div>

  <!-- SOHBET EKRANI -->
  <div id="chatScreen" style="display:none;">
    <div class="container">
      <header id="chatHeader">Soohbet: <span id="chatWithUser">Misafir</span></header>
      <div id="chatArea"></div>
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Mesaj yaz..." />
        <button id="sendBtn" onclick="sendMessage()">Gönder</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase yapılandırması
    const firebaseConfig = {
      apiKey: "AIzaSyCICiMDhK5MkQDq4dbV_9jkDMt4n3MUpEg",
      authDomain: "sohbetim-9a9d7.firebaseapp.com",
      databaseURL: "https://sohbetim-9a9d7-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sohbetim-9a9d7",
      storageBucket: "sohbetim-9a9d7.firebasestorage.app",
      messagingSenderId: "277333150871",
      appId: "1:277333150871:web:d923f8cddb19ec2f672dd2"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let currentUsername = "";
    let otherUserId = ""; // Karşı taraf ID

    // Uyarı göster
    function showAlert(id, msg, type) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.style.display = "block";
      el.className = `alert alert-${type}`;
      setTimeout(() => el.style.display = "none", 5000);
    }

    // Oturum kontrolü
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById("auth").style.display = "none";
        document.getElementById("chatScreen").style.display = "block";

        // Kullanıcı adını bir kez sor
        if (!localStorage.username) {
          const name = prompt("Kullanıcı adın (ID) nedir?");
          if (name) {
            localStorage.username = name;
            currentUsername = name;
          } else {
            logout();
          }
        } else {
          currentUsername = localStorage.username;
        }
      } else {
        document.getElementById("auth").style.display = "block";
        document.getElementById("chatScreen").style.display = "none";
      }
    });

    // Kayıt ol
    function register() {
      const email = document.getElementById("registerEmail").value;
      const password = document.getElementById("registerPassword").value;
      const username = document.getElementById("registerUsername").value;

      if (!username) return showAlert("error", "ID gir!", "error");

      auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
          localStorage.username = username;
          showAlert("success", "Kayıt başarılı!", "success");
        })
        .catch(e => showAlert("error", e.message, "error"));
    }

    // Giriş yap
    function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          const name = prompt("Kullanıcı adın (ID) nedir?");
          if (name) localStorage.username = name;
        })
        .catch(e => showAlert("error", e.message, "error"));
    }

    // Şifre sıfırla
    function resetPassword() {
      const email = document.getElementById("loginEmail").value;
      if (!email) return showAlert("error", "E-posta gir", "error");
      auth.sendPasswordResetEmail(email)
        .then(() => showAlert("success", "E-postana link gitti", "success"))
        .catch(e => showAlert("error", e.message, "error"));
    }

    // Çıkış yap
    function logout() {
      auth.signOut();
      localStorage.removeItem("username");
    }

    // Sohbet başlat
    function startChat(userId) {
      otherUserId = userId;
      document.getElementById("chatWithUser").innerText = userId;
      loadMessages();
    }

    // Mesaj yükle
    function loadMessages() {
      if (!otherUserId) return;

      const chatKey = [currentUser.uid, otherUserId].sort().join("_");
      const chatRef = db.ref("chats/" + chatKey);

      chatRef.limitToLast(50).on("value", snap => {
        const area = document.getElementById("chatArea");
        area.innerHTML = "";

        snap.forEach(child => {
          const data = child.val();
          const isSelf = data.from === currentUsername;

          const msg = document.createElement("div");
          msg.className = "msg " + (isSelf ? "msg-self" : "msg-other");
          msg.innerText = data.text;
          area.appendChild(msg);
        });

        area.scrollTop = area.scrollHeight;
      });
    }

    // Mesaj gönder
    function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !otherUserId) return;

      const chatKey = [currentUser.uid, otherUserId].sort().join("_");
      const chatRef = db.ref("chats/" + chatKey);

      chatRef.push({
        from: currentUsername,
        text: text,
        timestamp: Date.now()
      });

      input.value = "";
    }

    // Enter ile mesaj gönder
    document.getElementById("messageInput").onkeydown = e => {
      if (e.key === "Enter") sendMessage();
    };

    // Otomatik mesaj yükleme (gerçek zamanlı)
    window.startChat = startChat; // dışarıdan çağrılabilir yap
  </script>

  <!-- KULLANICI ARAMA (Test için) -->
  <script>
    // Test amaçlı: başka bir ID ile sohbet başlat
    // Gerçek kullanımda, kullanıcı listesi olur
    setTimeout(() => {
      if (document.getElementById("chatScreen").style.display === "block" && !otherUserId) {
        const id = prompt("Kimle sohbet etmek istersin? (Karşı tarafın ID'si)", "test123");
        if (id) startChat(id);
      }
    }, 1000);
  </script>
</body>
</html>
