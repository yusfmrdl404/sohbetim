<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#075e54" />
  <title>üîê Sohbetim + AI</title>

  <!-- Bildirim sesi -->
  <audio id="notificationSound" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" preload="auto"></audio>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

    :root {
      --main: #075e54;
      --main-dark: #054c47;
      --gray: #e0e0e0;
      --light-gray: #f0f2f5;
      --text: #333;
      --border: #ddd;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--light-gray);
      margin: 0;
      padding: 0;
      transition: background 0.3s;
      color: var(--text);
    }

    body.dark-mode {
      --main: #0d47a1;
      --main-dark: #0b3d8f;
      --gray: #333;
      --light-gray: #1a1a1a;
      --text: #e0e0e0;
      --border: #444;
      background: #121212;
    }

    .container {
      max-width: 600px;
      margin: 20px auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      overflow: hidden;
      height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .container.dark-mode {
      background: #1e1e1e;
      color: #e0e0e0;
    }

    header {
      background: var(--main);
      color: white;
      padding: 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
    }

    .btn {
      background: var(--main);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn:hover {
      background: var(--main-dark);
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: white;
      color: var(--text);
    }

    input:focus {
      outline: 2px solid var(--main);
    }

    .container.dark-mode input {
      background: #333;
      border-color: #555;
    }

    #chatArea {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: var(--light-gray);
      display: flex;
      flex-direction: column;
    }

    .msg {
      max-width: 70%;
      padding: 10px 14px;
      margin: 6px 0;
      border-radius: 14px 14px 0 14px;
      line-height: 1.4;
      position: relative;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg-self {
      background: var(--main);
      color: white;
      align-self: flex-end;
      border-radius: 14px 14px 14px 0;
    }

    .msg-other {
      background: var(--gray);
      color: var(--text);
      align-self: flex-start;
    }

    .msg img {
      max-width: 200px;
      border-radius: 8px;
      margin-top: 5px;
    }

    .status {
      font-size: 10px;
      margin-left: 5px;
      opacity: 0.8;
    }

    .input-area {
      display: flex;
      padding: 12px;
      background: white;
      border-top: 1px solid var(--border);
    }

    .container.dark-mode .input-area {
      background: #1e1e1e;
      border-top-color: #444;
    }

    #messageInput {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 20px;
      outline: none;
    }

    .container.dark-mode #messageInput {
      background: #333;
      border-color: #555;
      color: #fff;
    }

    #sendBtn, #attachBtn, #micBtn {
      margin-left: 8px;
      padding: 0 14px;
      background: var(--main);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }

    .user-list-container, .group-list-container {
      background: #f8f9fa;
      padding: 10px;
      border-bottom: 1px solid var(--border);
      height: 180px;
      overflow-y: auto;
      font-size: 14px;
    }

    .container.dark-mode .user-list-container, .container.dark-mode .group-list-container {
      background: #2a2a2a;
      border-bottom-color: #444;
    }

    .user-item, .group-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      margin: 4px 0;
      background: #f0f0f0;
      border-radius: 8px;
      cursor: pointer;
    }

    .container.dark-mode .user-item, .container.dark-mode .group-item {
      background: #333;
    }

    .user-item:hover, .group-item:hover {
      background: #e0e0e0;
    }

    .container.dark-mode .user-item:hover {
      background: #444;
    }

    .user-item img, .group-item img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .search-box {
      margin: 10px 0;
      display: flex;
      gap: 5px;
    }

    .search-box input {
      margin: 0;
      font-size: 13px;
    }

    .settings-section {
      padding: 15px;
      background: white;
      border-bottom: 1px solid var(--border);
    }

    .container.dark-mode .settings-section {
      background: #1e1e1e;
    }

    .avatar-upload {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .avatar-upload img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .alert {
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .container.dark-mode .alert-error {
      background: #444;
      color: #fff;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .container.dark-mode .alert-success {
      background: #444;
      color: #fff;
    }

    [id] { display: none; }
  </style>
</head>
<body>

  <!-- Gƒ∞Rƒ∞≈û EKRANI -->
  <div id="auth" style="display:block;">
    <div class="container" style="height:auto; position:relative;">
      <button onclick="toggleDarkMode()" class="btn btn-sm" style="position:absolute; top:10px; right:10px;">üåô</button>
      <header><h2>üîê Giri≈ü Yap</h2></header>
      <div class="content">
        <div class="alert alert-error" id="error"></div>
        <div class="alert alert-success" id="success"></div>
        <input type="email" id="loginEmail" placeholder="E-posta" />
        <input type="password" id="loginPassword" placeholder="≈ûifre" />
        <button onclick="login()" class="btn">Giri≈ü Yap</button>
        <p><button onclick="resetPassword()" class="btn btn-outline btn-sm">≈ûifremi Unuttum</button></p>
        <p id="resendSection" style="display:none;">
          <button onclick="resendVerification()" class="btn btn-outline btn-sm">üìß Doƒürulama Maili G√∂nder</button>
          <span id="resendTimer"></span>
        </p>
        <hr>
        <h3>üìù Kayƒ±t Ol</h3>
        <input type="email" id="registerEmail" placeholder="E-posta" />
        <input type="text" id="registerUsername" placeholder="Kullanƒ±cƒ± Adƒ± (ID)" />
        <input type="password" id="registerPassword" placeholder="≈ûifre" />
        <button onclick="register()" class="btn">Kayƒ±t Ol</button>
      </div>
    </div>
  </div>

  <!-- HESAP AYARLARI -->
  <div id="settingsScreen">
    <div class="container">
      <header>
        Hesap Ayarlarƒ±
        <button onclick="goToChat()" class="btn btn-sm">Geri</button>
      </header>
      <div class="settings-section">
        <h3>üë§ Profil</h3>
        <div class="avatar-upload">
          <img id="currentAvatar" src="" alt="pp">
          <input type="file" id="avatarInput" accept="image/*">
          <button onclick="changeAvatar()" class="btn btn-sm">Deƒüi≈ütir</button>
        </div>
        <input type="text" id="updateUsername" placeholder="Yeni kullanƒ±cƒ± adƒ±">
        <button onclick="updateUsername()" class="btn btn-sm">G√ºncelle</button>
      </div>
    </div>
  </div>

  <!-- SOHBET EKRANI -->
  <div id="chatScreen">
    <div class="container">
      <!-- Kullanƒ±cƒ± ve Grup Listesi -->
      <div class="user-list-container">
        <strong>üë• Kullanƒ±cƒ±lar</strong>
        <div id="userList"></div>
      </div>
      <div class="group-list-container">
        <strong>üß© Gruplar</strong>
        <button onclick="createGroup()" class="btn btn-sm">+ Yeni Grup</button>
        <div id="groupList"></div>
      </div>

      <!-- Sohbet Ba≈ülƒ±ƒüƒ± -->
      <header>
        <span id="chatWithUser">Kimse se√ßilmedi</span>
        <div style="display:flex;gap:5px;">
          <button onclick="openSettings()" class="btn btn-sm">‚öôÔ∏è</button>
          <button onclick="toggleDarkMode()" class="btn btn-sm">üåô</button>
          <button onclick="startAIChat()" class="btn btn-sm">ü§ñ</button>
        </div>
      </header>

      <!-- Mesaj Alanƒ± -->
      <div id="chatArea"></div>

      <!-- Arama -->
      <div class="search-box" style="display:none;">
        <input type="text" id="searchInput" placeholder="Mesaj ara..." oninput="searchMessages()">
        <button onclick="closeSearch()" class="btn btn-sm">X</button>
      </div>

      <!-- Mesaj G√∂nderme -->
      <div class="input-area">
        <button id="attachBtn" onclick="document.getElementById('fileInput').click()">üìé</button>
        <input type="file" id="fileInput" accept="image/*,.txt,.pdf" style="display:none" onchange="handleFile(this)">
        <button id="micBtn" onclick="toggleMic()">üé§</button>
        <input type="text" id="messageInput" placeholder="Mesaj yaz..." onkeydown="if(event.key==='Enter')sendMessage()">
        <button id="sendBtn" onclick="sendMessage()">G√∂nder</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // üî• Firebase yapƒ±landƒ±rmasƒ±
    const firebaseConfig = {
      apiKey: "AIzaSyCICiMDhK5MkQDq4dbV_9jkDMt4n3MUpEg",
      authDomain: "sohbetim-9a9d7.firebaseapp.com",
      databaseURL: "https://sohbetim-9a9d7-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sohbetim-9a9d7",
      storageBucket: "sohbetim-9a9d7.firebasestorage.app",
      messagingSenderId: "277333150871",
      appId: "1:277333150871:web:d923f8cddb19ec2f672dd2"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let currentUsername = "";
    let otherUserId = "";
    let chatType = "user"; // "user", "group", "ai"
    let currentGroupId = null;
    let recognizing = false;
    const recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const SpeechGrammarList = window.SpeechGrammarList || window.webkitSpeechGrammarList;
    const SpeechRecognitionEvent = window.SpeechRecognitionEvent || window.webkitSpeechRecognitionEvent;
    const recognizer = recognition ? new recognition() : null;
    const sound = document.getElementById("notificationSound");

    // Uyarƒ± g√∂ster
    function showAlert(id, msg, type) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.style.display = "block";
      el.className = `alert alert-${type}`;
      setTimeout(() => el.style.display = "none", 5000);
    }

    // Ekran g√∂ster
    function show(id) {
      document.querySelectorAll("[id]").forEach(el => el.style.display = "none");
      document.getElementById(id).style.display = "block";
    }

    // Koyu/A√ßƒ±k tema
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const buttons = document.querySelectorAll('button[onclick*="toggleDarkMode"]');
      buttons.forEach(b => b.innerText = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // Sayfa y√ºkle
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.querySelectorAll('button[onclick*="toggleDarkMode"]').forEach(b => b.innerText = '‚òÄÔ∏è');
      }
    });

    // Oturum kontrol√º
    auth.onAuthStateChanged(user => {
      if (user) {
        if (!user.emailVerified) {
          show('auth');
          document.getElementById("resendSection").style.display = "block";
          startResendTimer();
          showAlert("error", "üìß L√ºtfen e-postanƒ±zƒ± doƒürulayƒ±n.", "error");
          return;
        }

        currentUser = user;
        currentUsername = localStorage.username || user.email.split('@')[0];
        if (!localStorage.username) {
          const name = prompt("Kullanƒ±cƒ± adƒ±nƒ±z (ID) nedir?");
          if (name) {
            localStorage.username = name;
            currentUsername = name;
          } else {
            logout(); return;
          }
        }

        loadUserList();
        loadGroupList();
        updateAvatarDisplay();
        show('chatScreen');
      } else {
        show('auth');
      }
    });

    // Kullanƒ±cƒ± listesi (kendini gizle)
    function loadUserList() {
      db.ref("users").on("value", (snapshot) => {
        const list = document.getElementById("userList");
        list.innerHTML = "";
        snapshot.forEach((child) => {
          const userId = child.key;
          if (userId === currentUser.uid) return;
          const data = child.val();
          const item = document.createElement("div");
          item.className = "user-item";
          item.innerHTML = `<img src="${data.photoURL}"><div><strong>${data.username}</strong></div>`;
          item.onclick = () => startChat(userId, "user");
          list.appendChild(item);
        });
      });
    }

    // Grup listesi
    function loadGroupList() {
      db.ref("groups").on("value", (snapshot) => {
        const list = document.getElementById("groupList");
        list.innerHTML = "";
        snapshot.forEach((child) => {
          const data = child.val();
          if (!data.members?.includes(currentUser.uid)) return;
          const item = document.createElement("div");
          item.className = "group-item";
          item.innerHTML = `<img src="${data.photoURL || 'https://ui-avatars.com/api/?name=G'}"><div><strong>${data.name}</strong></div>`;
          item.onclick = () => startChat(child.key, "group");
          list.appendChild(item);
        });
      });
    }

    // Grup olu≈ütur
    function createGroup() {
      const name = prompt("Grup adƒ±?");
      if (!name) return;
      const groupId = db.ref("groups").push().key;
      db.ref("groups/" + groupId).set({
        name,
        photoURL: "https://ui-avatars.com/api/?name=" + name,
        creator: currentUser.uid,
        members: [currentUser.uid]
      });
    }

    // Sohbet ba≈ülat
    function startChat(id, type) {
      chatType = type;
      if (type === "user") {
        otherUserId = id;
        db.ref("users/" + id).once("value", (snap) => {
          document.getElementById("chatWithUser").innerText = snap.val().username;
        });
      } else if (type === "group") {
        currentGroupId = id;
        db.ref("groups/" + id).once("value", (snap) => {
          document.getElementById("chatWithUser").innerText = snap.val().name;
        });
      }
      if (chatType !== "ai") {
        loadMessages();
      }
    }

    // Mesajlarƒ± y√ºkle
    function loadMessages() {
      const ref = chatType === "user"
        ? db.ref("chats/" + [currentUser.uid, otherUserId].sort().join("_"))
        : db.ref("groupChats/" + currentGroupId);

      ref.limitToLast(50).on("value", (snapshot) => {
        const area = document.getElementById("chatArea");
        area.innerHTML = "";
        snapshot.forEach((child) => {
          const data = child.val();
          const isSelf = data.from === currentUsername;
          const msg = document.createElement("div");
          msg.className = "msg " + (isSelf ? "msg-self" : "msg-other");
          if (data.image) {
            msg.innerHTML = `<img src="${data.image}">`;
          } else {
            msg.innerText = data.text;
          }
          if (isSelf) {
            const status = document.createElement("span");
            status.className = "status";
            status.innerText = data.seen ? "üëÄ" : "‚úì";
            msg.appendChild(status);
          }
          area.appendChild(msg);
        });
        area.scrollTop = area.scrollHeight;
        if (snapshot.size > 0 && !isSelf) sound.play().catch(() => {});
      });
    }

    // Dosya i≈üle
    function handleFile(input) {
      const file = input.files[0];
      if (!file) return;
      if (file.type === "text/plain") {
        const reader = new FileReader();
        reader.onload = (e) => {
          const content = e.target.result.substring(0, 500);
          const prompt = `A≈üaƒüƒ±daki metni √∂zetle:\n\n${content}`;
          if (chatType === "ai") {
            document.getElementById("messageInput").value = prompt;
          } else {
            sendMessageWithContent(`üìÑ Dosya: ${file.name}\n\n√ñzet: ${content}...`);
          }
        };
        reader.readAsText(file);
      } else if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = (e) => {
          sendMessageWithContent({ image: e.target.result });
        };
        reader.readAsDataURL(file);
      } else {
        alert("Sadece resim, metin dosyasƒ± desteklenir.");
      }
      input.value = "";
    }

    // Mesaj g√∂nder (AI dahil)
    async function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text && !window.aiResponse) return;

      if (chatType === "ai") {
        const userMsg = document.createElement("div");
        userMsg.className = "msg msg-self";
        userMsg.innerText = text;
        document.getElementById("chatArea").appendChild(userMsg);
        input.value = "";

        const typing = document.createElement("div");
        typing.className = "msg msg-other";
        typing.id = "ai-typing";
        typing.innerText = "Yazƒ±yor...";
        document.getElementById("chatArea").appendChild(typing);

        try {
          const reply = await getAISuggestion(text);
          document.getElementById("ai-typing").remove();
          const aiMsg = document.createElement("div");
          aiMsg.className = "msg msg-other";
          aiMsg.innerText = reply;
          document.getElementById("chatArea").appendChild(aiMsg);
        } catch (e) {
          document.getElementById("ai-typing").remove();
          const errorMsg = document.createElement("div");
          errorMsg.className = "msg msg-other";
          errorMsg.innerText = "AI'ye ula≈üƒ±lamadƒ±.";
          document.getElementById("chatArea").appendChild(errorMsg);
        }

        document.getElementById("chatArea").scrollTop = document.getElementById("chatArea").scrollHeight;
        return;
      }

      sendMessageWithContent(text);
    }

    function sendMessageWithContent(content) {
      const ref = chatType === "user"
        ? db.ref("chats/" + [currentUser.uid, otherUserId].sort().join("_"))
        : db.ref("groupChats/" + currentGroupId);

      if (typeof content === "object" && content.image) {
        ref.push({
          from: currentUsername,
          image: content.image,
          timestamp: Date.now()
        });
      } else {
        ref.push({
          from: currentUsername,
          text: content,
          timestamp: Date.now(),
          seen: false
        });
      }
    }

    // ü§ñ AI Asistan
    function startAIChat() {
      if (confirm("AI Asistan ile sohbet etmek istiyor musunuz?")) {
        document.getElementById("chatWithUser").innerText = "ü§ñ AI Asistan";
        chatType = "ai";
        const area = document.getElementById("chatArea");
        area.innerHTML = "";
        const msg = document.createElement("div");
        msg.className = "msg msg-other";
        msg.innerText = "Merhaba! Ben AI asistanƒ±nƒ±m. Soru sorabilir, konu≈üabilir, metin √∂zetleyebilirim.";
        area.appendChild(msg);
        area.scrollTop = area.scrollHeight;
      }
    }

    async function getAISuggestion(text) {
      const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": "Bearer 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",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "llama3-8b-8192",
          messages: [
            { role: "system", content: "Sen yardƒ±msever, kƒ±sa ve net cevap veren bir AI'sƒ±n. T√ºrk√ße konu≈ü." },
            { role: "user", content: text }
          ],
          temperature: 0.7,
          max_tokens: 256
        })
      });

      const data = await response.json();
      return data.choices[0].message.content;
    }

    // üé§ Sesli mesaj
    function toggleMic() {
      if (!recognizer) {
        alert("Tarayƒ±cƒ± ses tanƒ±mayƒ± desteklemiyor.");
        return;
      }

      if (recognizing) {
        recognizer.stop();
        document.getElementById("micBtn").innerText = "üé§";
        recognizing = false;
      } else {
        recognizer.start();
        document.getElementById("micBtn").innerText = "üî¥";
        recognizing = true;
      }
    }

    if (recognizer) {
      recognizer.continuous = false;
      recognizer.interimResults = false;
      recognizer.lang = 'tr-TR';

      recognizer.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById("messageInput").value = transcript;
      };

      recognizer.onend = () => {
        recognizing = false;
        document.getElementById("micBtn").innerText = "üé§";
      };
    }

    // Diƒüer fonksiyonlar (login, register, settings, vs.) a≈üaƒüƒ±da...

    function openSettings() {
      show('settingsScreen');
    }

    function goToChat() {
      show('chatScreen');
    }

    function changeAvatar() {
      const input = document.getElementById("avatarInput");
      if (input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          localStorage.photoURL = e.target.result;
          updateAvatarDisplay();
          db.ref("users/" + currentUser.uid).update({ photoURL: e.target.result });
          showAlert("success", "Profil resmi deƒüi≈ütirildi.", "success");
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function updateAvatarDisplay() {
      const img = document.getElementById("currentAvatar");
      img.src = localStorage.photoURL || "https://ui-avatars.com/api/?name=" + currentUsername;
    }

    function updateUsername() {
      const input = document.getElementById("updateUsername");
      const name = input.value.trim();
      if (name) {
        localStorage.username = name;
        currentUsername = name;
        db.ref("users/" + currentUser.uid).update({ username: name });
        showAlert("success", "Kullanƒ±cƒ± adƒ± g√ºncellendi.", "success");
        input.value = "";
      }
    }

    function searchMessages() {
      const term = document.getElementById("searchInput").value.toLowerCase();
      const messages = document.querySelectorAll("#chatArea .msg");
      messages.forEach(m => {
        const text = m.innerText.toLowerCase();
        m.style.backgroundColor = text.includes(term) ? "#ffeb3b" : "";
      });
    }

    function closeSearch() {
      document.querySelector(".search-box").style.display = "none";
      document.getElementById("searchInput").value = "";
      const messages = document.querySelectorAll("#chatArea .msg");
      messages.forEach(m => m.style.backgroundColor = "");
    }

    function resendVerification() {
      const user = auth.currentUser;
      const email = user.email;
      const last = localStorage.getItem("lastResend_" + email);
      const now = Date.now();
      if (last && now - last < 3 * 60 * 60 * 1000) {
        const left = Math.ceil((3 * 60 * 60 * 1000 - (now - last)) / 60000);
        showAlert("error", `${left} dakika sonra tekrar deneyin.`, "error");
        return;
      }
      user.sendEmailVerification().then(() => {
        localStorage.setItem("lastResend_" + email, now);
        startResendTimer();
        showAlert("success", "Doƒürulama maili g√∂nderildi.", "success");
      }).catch(e => showAlert("error", e.message, "error"));
    }

    function startResendTimer() {
      const email = document.getElementById("loginEmail").value || (auth.currentUser?.email);
      if (!email) return;
      const last = localStorage.getItem("lastResend_" + email);
      if (!last) return;
      const diff = 3 * 60 * 60 * 1000 - (Date.now() - last);
      if (diff > 0) {
        const mins = Math.ceil(diff / 60000);
        document.getElementById("resendTimer").innerText = ` (${mins} dk sonra)`;
        setTimeout(() => document.getElementById("resendTimer").innerText = "", diff);
      }
    }

    function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      auth.signInWithEmailAndPassword(email, password).catch(e => showAlert("error", e.message, "error"));
    }

    function register() {
      const email = document.getElementById("registerEmail").value;
      const password = document.getElementById("registerPassword").value;
      const username = document.getElementById("registerUsername").value;
      if (!username) return showAlert("error", "Kullanƒ±cƒ± adƒ± gir!", "error");

      auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
          localStorage.username = username;
          db.ref("users/" + auth.currentUser.uid).set({
            username: username,
            email: email,
            photoURL: `https://ui-avatars.com/api/?name=${username}`,
            online: true
          });
          return auth.currentUser.sendEmailVerification();
        })
        .then(() => {
          showAlert("success", "Doƒürulama maili g√∂nderildi.", "success");
          auth.signOut();
        })
        .catch(e => showAlert("error", e.message, "error"));
    }

    function resetPassword() {
      const email = document.getElementById("loginEmail").value;
      if (!email) return showAlert("error", "E-posta girin.", "error");
      auth.sendPasswordResetEmail(email)
        .then(() => showAlert("success", "Sƒ±fƒ±rlama baƒülantƒ±sƒ± g√∂nderildi.", "success"))
        .catch(e => showAlert("error", e.message, "error"));
    }

    function logout() {
      if (currentUser) {
        db.ref("users/" + currentUser.uid).update({ online: false });
      }
      auth.signOut();
      localStorage.removeItem("username");
      localStorage.removeItem("photoURL");
    }
  </script>
</body>
</html>
