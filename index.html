<!DOCTYPE html>
<html>
<head>
  <title>Sohbet Sitem</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial; margin: 30px; }
    #auth, #chat { margin-top: 20px; }
    input, button { padding: 8px; margin: 5px; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin: 10px 0; }
    .msg { padding: 5px; margin: 5px 0; background: #f0f0f0; }
  </style>
</head>
<body>

  <h1>Sohbet Sitem</h1>

  <!-- Giriş / Kayıt -->
  <div id="auth">
    <input type="email" id="email" placeholder="E-posta">
    <input type="text" id="username" placeholder="ID (kullanıcı adı)">
    <input type="password" id="password" placeholder="Şifre">
    <button onclick="register()">Kayıt Ol</button>
    <button onclick="login()">Giriş Yap</button>
    <button onclick="logout()" style="display:none">Çıkış</button>
  </div>

  <!-- Sohbet -->
  <div id="chat" style="display:none">
    <h3>Hoş geldin, <span id="userLabel"></span>!</h3>
    <input type="text" id="searchId" placeholder="ID ile kişi ara">
    <button onclick="startChat()">Mesaj Başlat</button>
    <div id="messages"></div>
    <input type="text" id="message" placeholder="Mesaj yaz">
    <button onclick="sendMessage()">Gönder</button>
  </div>

  <!-- Firebase SDK (boşluksuz ve doğru) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase yapılandırması
    const firebaseConfig = {
      apiKey: "AIzaSyCICiMDhK5MkQDq4dbV_9jkDMt4n3MUpEg",
      authDomain: "sohbetim-9a9d7.firebaseapp.com",
      databaseURL: "https://sohbetim-9a9d7-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sohbetim-9a9d7",
      storageBucket: "sohbetim-9a9d7.firebasestorage.app",
      messagingSenderId: "277333150871",
      appId: "1:277333150871:web:d923f8cddb19ec2f672dd2",
      measurementId: "G-G5FXCJYWMC"
    };

    // Firebase'i başlat
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let chatWith = null;

    // Oturum durumu kontrolü
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById("auth").style.display = "none";
        document.getElementById("chat").style.display = "block";
        document.getElementById("userLabel").innerText = localStorage.username || "Misafir";
        loadMessages();
      } else {
        document.getElementById("chat").style.display = "none";
        document.getElementById("auth").style.display = "block";
      }
    });

    // Kayıt ol
    function register() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const username = document.getElementById("username").value;

      if (!username) return alert("Lütfen bir ID (kullanıcı adı) girin!");

      auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
          localStorage.username = username;
          db.ref("users/" + auth.currentUser.uid).set({ username });
          alert("Kayıt başarılı! Artık sohbet edebilirsin.");
        })
        .catch(error => {
          alert("Hata: " + error.message);
        });
    }

    // Giriş yap
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      if (!email || !password) return alert("E-posta ve şifre girin!");

      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          const username = prompt("ID'niz (kullanıcı adınız) nedir?");
          if (username) {
            localStorage.username = username;
          }
        })
        .catch(error => {
          alert("Hata: " + error.message);
        });
    }

    // Çıkış yap
    function logout() {
      auth.signOut();
      localStorage.removeItem("username");
    }

    // Sohbet başlat
    function startChat() {
      chatWith = document.getElementById("searchId").value;
      if (!chatWith) return alert("Lütfen bir ID girin!");
      loadMessages();
    }

    // Mesaj gönder
    function sendMessage() {
      if (!chatWith || !currentUser) return;

      const messageInput = document.getElementById("message");
      const message = messageInput.value.trim();

      if (!message) return;

      const chatRef = db.ref("chats/" + [currentUser.uid, chatWith].sort().join("_"));
      chatRef.push({
        from: localStorage.username,
        text: message,
        time: Date.now()
      });

      messageInput.value = "";
    }

    // Mesajları yükle
    function loadMessages() {
      if (!chatWith || !currentUser) return;

      const chatKey = [currentUser.uid, chatWith].sort().join("_");
      const chatRef = db.ref("chats/" + chatKey);

      chatRef.limitToLast(50).on("value", (snapshot) => {
        const msgDiv = document.getElementById("messages");
        msgDiv.innerHTML = "";

        snapshot.forEach((childSnapshot) => {
          const data = childSnapshot.val();
          const msgEl = document.createElement("div");
          msgEl.className = "msg";
          msgEl.innerHTML = `<b>${data.from}</b>: ${data.text}`;
          msgDiv.appendChild(msgEl);
        });

        msgDiv.scrollTop = msgDiv.scrollHeight;
      });
    }
  </script>
</body>
</html>
