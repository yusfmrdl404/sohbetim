<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#075e54" />
  <title>üîê Sohbetim</title>

  <!-- Bildirim sesi -->
  <audio id="notificationSound" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" preload="auto"></audio>

  <!-- PWA Manifest (D√ºzeltildi: Dinamik olarak ekle) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const manifest = {
        "name": "Sohbetim",
        "short_name": "Sohbet",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#075e54",
        "theme_color": "#075e54",
        "icons": [
          {
            "src": "https://ui-avatars.com/api/?name=S",
            "sizes": "192x192",
            "type": "image/png"
          }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = url;
      document.head.appendChild(link);
    });
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

    :root {
      --main: #075e54;
      --main-dark: #054c47;
      --gray: #e0e0e0;
      --light-gray: #f0f2f5;
      --text: #333;
      --border: #ddd;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--light-gray);
      margin: 0;
      padding: 0;
      transition: background 0.3s;
      color: var(--text);
    }

    body.dark-mode {
      --main: #0d47a1;
      --main-dark: #0b3d8f;
      --gray: #333;
      --light-gray: #1a1a1a;
      --text: #e0e0e0;
      --border: #444;
      background: #121212;
    }

    .container {
      max-width: 600px;
      margin: 20px auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      overflow: hidden;
      height: 90vh;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .container.dark-mode {
      background: #1e1e1e;
      color: #e0e0e0;
    }

    header {
      background: var(--main);
      color: white;
      padding: 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
    }

    .btn {
      background: var(--main);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn:hover {
      background: var(--main-dark);
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    input, button {
      transition: all 0.2s;
    }

    input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: white;
      color: var(--text);
    }

    input:focus {
      outline: 2px solid var(--main);
    }

    .container.dark-mode input {
      background: #333;
      border-color: #555;
    }

    #chatArea {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: var(--light-gray);
      display: flex;
      flex-direction: column;
    }

    .msg {
      max-width: 70%;
      padding: 10px 14px;
      margin: 6px 0;
      border-radius: 14px 14px 0 14px;
      line-height: 1.4;
      position: relative;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg-self {
      background: var(--main);
      color: white;
      align-self: flex-end;
      border-radius: 14px 14px 14px 0;
    }

    .msg-other {
      background: var(--gray);
      color: var(--text);
      align-self: flex-start;
    }

    .msg img {
      max-width: 200px;
      border-radius: 8px;
      margin-top: 5px;
    }

    .status {
      font-size: 10px;
      margin-left: 5px;
      opacity: 0.8;
    }

    .input-area {
      display: flex;
      padding: 12px;
      background: white;
      border-top: 1px solid var(--border);
    }

    .container.dark-mode .input-area {
      background: #1e1e1e;
      border-top-color: #444;
    }

    #messageInput {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 20px;
      outline: none;
    }

    .container.dark-mode #messageInput {
      background: #333;
      border-color: #555;
      color: #fff;
    }

    #sendBtn, #attachBtn {
      margin-left: 8px;
      padding: 0 14px;
      background: var(--main);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }

    .user-list-container, .group-list-container {
      background: #f8f9fa;
      padding: 10px;
      border-bottom: 1px solid var(--border);
      height: 180px;
      overflow-y: auto;
      font-size: 14px;
    }

    .container.dark-mode .user-list-container, .container.dark-mode .group-list-container {
      background: #2a2a2a;
      border-bottom-color: #444;
    }

    .user-item, .group-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      margin: 4px 0;
      background: #f0f0f0;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .container.dark-mode .user-item, .container.dark-mode .group-item {
      background: #333;
    }

    .user-item:hover, .group-item:hover {
      background: #e0e0e0;
    }

    .container.dark-mode .user-item:hover {
      background: #444;
    }

    .user-item img, .group-item img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .search-box {
      margin: 10px 0;
      display: flex;
      gap: 5px;
    }

    .search-box input {
      margin: 0;
      font-size: 13px;
    }

    .settings-section {
      padding: 15px;
      background: white;
      border-bottom: 1px solid var(--border);
    }

    .container.dark-mode .settings-section {
      background: #1e1e1e;
    }

    .avatar-upload {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .avatar-upload img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .alert {
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .container.dark-mode .alert-error {
      background: #444;
      color: #fff;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .container.dark-mode .alert-success {
      background: #444;
      color: #fff;
    }

    #auth, #settingsScreen, #chatScreen { display: none; }
  </style>
</head>
<body>

  <!-- Gƒ∞Rƒ∞≈û EKRANI -->
  <div id="auth">
    <div class="container" style="height:auto; position:relative;">
      <button onclick="toggleDarkMode()" class="btn btn-sm" style="position:absolute; top:10px; right:10px;">üåô</button>
      <h2 style="text-align:center; margin:20px 0;">üîê Giri≈ü Yap</h2>
      <div class="alert alert-error" id="error"></div>
      <div class="alert alert-success" id="success"></div>
      <div class="form">
        <input type="email" id="loginEmail" placeholder="E-posta" />
        <input type="password" id="loginPassword" placeholder="≈ûifre" />
        <button onclick="login()" class="btn">Giri≈ü Yap</button>
        <p><button onclick="resetPassword()" class="btn btn-outline btn-sm">≈ûifremi Unuttum</button></p>
        <p id="resendSection" style="display:none;">
          <button onclick="resendVerification()" class="btn btn-outline btn-sm">üìß Doƒürulama Maili G√∂nder</button>
          <span id="resendTimer"></span>
        </p>
        <hr>
        <h3>üìù Kayƒ±t Ol</h3>
        <input type="email" id="registerEmail" placeholder="E-posta" />
        <input type="text" id="registerUsername" placeholder="Kullanƒ±cƒ± Adƒ± (ID)" />
        <input type="password" id="registerPassword" placeholder="≈ûifre" />
        <button onclick="register()" class="btn">Kayƒ±t Ol</button>
      </div>
    </div>
  </div>

  <!-- HESAP AYARLARI -->
  <div id="settingsScreen" style="display:none;">
    <div class="container">
      <header>
        Hesap Ayarlarƒ±
        <button onclick="goToChat()" class="btn btn-sm">Geri</button>
      </header>
      <div class="settings-section">
        <h3>üë§ Profil</h3>
        <div class="avatar-upload">
          <img id="currentAvatar" src="" alt="pp">
          <input type="file" id="avatarInput" accept="image/*">
          <button onclick="changeAvatar()" class="btn btn-sm">Deƒüi≈ütir</button>
        </div>
        <input type="text" id="updateUsername" placeholder="Yeni kullanƒ±cƒ± adƒ±">
        <button onclick="updateUsername()" class="btn btn-sm">G√ºncelle</button>
      </div>
    </div>
  </div>

  <!-- SOHBET EKRANI -->
  <div id="chatScreen" style="display:none;">
    <div class="container">
      <!-- Kullanƒ±cƒ± ve Grup Listesi -->
      <div class="user-list-container">
        <strong>üë• Kullanƒ±cƒ±lar</strong>
        <div id="userList"></div>
      </div>
      <div class="group-list-container">
        <strong>üß© Gruplar</strong>
        <button onclick="createGroup()" class="btn btn-sm">+ Yeni Grup</button>
        <div id="groupList"></div>
      </div>

      <!-- Sohbet Ba≈ülƒ±ƒüƒ± -->
      <header>
        <span id="chatWithUser">Kimse se√ßilmedi</span>
        <div style="display:flex;gap:5px;">
          <button onclick="openSettings()" class="btn btn-sm">‚öôÔ∏è</button>
          <button onclick="toggleDarkMode()" class="btn btn-sm">üåô</button>
        </div>
      </header>

      <!-- Mesaj Alanƒ± -->
      <div id="chatArea"></div>

      <!-- Arama -->
      <div class="search-box" style="display:none;">
        <input type="text" id="searchInput" placeholder="Mesaj ara..." oninput="searchMessages()">
        <button onclick="closeSearch()" class="btn btn-sm">X</button>
      </div>

      <!-- Mesaj G√∂nderme -->
      <div class="input-area">
        <button id="attachBtn" onclick="document.getElementById('fileInput').click()">üìé</button>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="sendFile(this)">
        <input type="text" id="messageInput" placeholder="Mesaj yaz..." onkeydown="if(event.key==='Enter')sendMessage()">
        <button id="sendBtn" onclick="sendMessage()">G√∂nder</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase yapƒ±landƒ±rmasƒ±
    const firebaseConfig = {
      apiKey: "AIzaSyCICiMDhK5MkQDq4dbV_9jkDMt4n3MUpEg",
      authDomain: "sohbetim-9a9d7.firebaseapp.com",
      databaseURL: "https://sohbetim-9a9d7-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sohbetim-9a9d7",
      storageBucket: "sohbetim-9a9d7.firebasestorage.app",
      messagingSenderId: "277333150871",
      appId: "1:277333150871:web:d923f8cddb19ec2f672dd2"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let currentUsername = "";
    let otherUserId = "";
    let chatType = "user"; // "user" or "group"
    let currentGroupId = null;
    const sound = document.getElementById("notificationSound");

    // Uyarƒ± g√∂ster
    function showAlert(id, msg, type) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.style.display = "block";
      el.className = `alert alert-${type}`;
      setTimeout(() => el.style.display = "none", 5000);
    }

    // Koyu/A√ßƒ±k tema
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const buttons = document.querySelectorAll('button[onclick*="toggleDarkMode"]');
      buttons.forEach(b => b.innerText = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // Sayfa y√ºkle
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.querySelectorAll('button[onclick*="toggleDarkMode"]').forEach(b => b.innerText = '‚òÄÔ∏è');
      }
    });

    // Ekran g√∂ster
    function showScreen(id) {
      document.querySelectorAll('#auth, #chatScreen, #settingsScreen').forEach(el => {
        el.style.display = el.id === id ? 'block' : 'none';
      });
    }

    // Oturum kontrol√º
    auth.onAuthStateChanged(user => {
      if (user) {
        if (!user.emailVerified) {
          showScreen('auth');
          document.getElementById("resendSection").style.display = "block";
          startResendTimer();
          showAlert("error", "üìß E-postanƒ±zƒ± doƒürulayƒ±n.", "error");
          return;
        }

        currentUser = user;
        currentUsername = localStorage.username || user.email.split('@')[0];
        if (!localStorage.username) {
          const name = prompt("Kullanƒ±cƒ± adƒ±nƒ±z (ID) nedir?");
          if (name) {
            localStorage.username = name;
            currentUsername = name;
          } else {
            logout(); return;
          }
        }

        loadUserList();
        loadGroupList();
        updateAvatarDisplay();
        showScreen('chat');
      } else {
        showScreen('auth');
      }
    });

    // Kullanƒ±cƒ± listesi (kendini gizle)
    function loadUserList() {
      db.ref("users").on("value", (snapshot) => {
        const list = document.getElementById("userList");
        list.innerHTML = "";
        snapshot.forEach((child) => {
          const userId = child.key;
          if (userId === currentUser.uid) return;
          const data = child.val();
          const item = document.createElement("div");
          item.className = "user-item";
          item.innerHTML = `<img src="${data.photoURL}"><div><strong>${data.username}</strong></div>`;
          item.onclick = () => startChat(userId, "user");
          list.appendChild(item);
        });
      });
    }

    // Grup listesi
    function loadGroupList() {
      db.ref("groups").on("value", (snapshot) => {
        const list = document.getElementById("groupList");
        list.innerHTML = "";
        snapshot.forEach((child) => {
          const data = child.val();
          if (!data.members?.includes(currentUser.uid)) return;
          const item = document.createElement("div");
          item.className = "group-item";
          item.innerHTML = `<img src="${data.photoURL || 'https://ui-avatars.com/api/?name=G'}"><div><strong>${data.name}</strong></div>`;
          item.onclick = () => startChat(child.key, "group");
          list.appendChild(item);
        });
      });
    }

    // Grup olu≈ütur
    function createGroup() {
      const name = prompt("Grup adƒ±?");
      if (!name) return;
      const groupId = db.ref("groups").push().key;
      db.ref("groups/" + groupId).set({
        name,
        photoURL: "https://ui-avatars.com/api/?name=" + name,
        creator: currentUser.uid,
        members: [currentUser.uid]
      });
    }

    // Sohbet ba≈ülat
    function startChat(id, type) {
      chatType = type;
      if (type === "user") {
        otherUserId = id;
        db.ref("users/" + id).once("value", (snap) => {
          document.getElementById("chatWithUser").innerText = snap.val().username;
        });
      } else {
        currentGroupId = id;
        db.ref("groups/" + id).once("value", (snap) => {
          document.getElementById("chatWithUser").innerText = snap.val().name;
        });
      }
      loadMessages();
    }

    // Mesajlarƒ± y√ºkle
    function loadMessages() {
      const ref = chatType === "user"
        ? db.ref("chats/" + [currentUser.uid, otherUserId].sort().join("_"))
        : db.ref("groupChats/" + currentGroupId);

      ref.limitToLast(50).on("value", async (snapshot) => {
        const area = document.getElementById("chatArea");
        area.innerHTML = "";
        for (let child of snapshot.entries()) {
          const data = child.val();
          if (data.encrypted) data.text = await decrypt(data.text);
          const isSelf = data.from === currentUsername;
          const msg = document.createElement("div");
          msg.className = "msg " + (isSelf ? "msg-self" : "msg-other");
          if (data.image) {
            msg.innerHTML = `<img src="${data.image}">`;
          } else {
            msg.innerText = data.text;
          }
          if (isSelf) {
            const status = document.createElement("span");
            status.className = "status";
            status.innerText = data.seen ? "üëÄ" : "‚úì";
            msg.appendChild(status);
          }
          area.appendChild(msg);
        }
        area.scrollTop = area.scrollHeight;
        if (snapshot.size > 0 && !isSelf) sound.play().catch(() => {});
      });
    }

    // Mesaj g√∂nder
    async function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text) return;
      const encrypted = await encrypt(text);
      const ref = chatType === "user"
        ? db.ref("chats/" + [currentUser.uid, otherUserId].sort().join("_"))
        : db.ref("groupChats/" + currentGroupId);
      ref.push({
        from: currentUsername,
        text: encrypted,
        timestamp: Date.now(),
        encrypted: true,
        seen: false
      });
      input.value = "";
    }

    // Fotoƒüraf g√∂nder
    function sendFile(input) {
      const file = input.files[0];
      if (!file || file.size > 2 * 1024 * 1024) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const ref = chatType === "user"
          ? db.ref("chats/" + [currentUser.uid, otherUserId].sort().join("_"))
          : db.ref("groupChats/" + currentGroupId);
        ref.push({
          from: currentUsername,
          image: e.target.result,
          timestamp: Date.now()
        });
      };
      reader.readAsDataURL(file);
      input.value = "";
    }

    // Hesap ayarlarƒ±
    function openSettings() {
      showScreen('settingsScreen');
    }

    function goToChat() {
      showScreen('chat');
    }

    function changeAvatar() {
      const input = document.getElementById("avatarInput");
      if (input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          localStorage.photoURL = e.target.result;
          updateAvatarDisplay();
          db.ref("users/" + currentUser.uid).update({ photoURL: e.target.result });
          showAlert("success", "Profil resmi deƒüi≈ütirildi.", "success");
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function updateAvatarDisplay() {
      const img = document.getElementById("currentAvatar");
      img.src = localStorage.photoURL || "https://ui-avatars.com/api/?name=" + currentUsername;
    }

    function updateUsername() {
      const input = document.getElementById("updateUsername");
      const name = input.value.trim();
      if (name) {
        localStorage.username = name;
        currentUsername = name;
        db.ref("users/" + currentUser.uid).update({ username: name });
        showAlert("success", "Kullanƒ±cƒ± adƒ± g√ºncellendi.", "success");
        input.value = "";
      }
    }

    // Mesaj ara
    function searchMessages() {
      const term = document.getElementById("searchInput").value.toLowerCase();
      const messages = document.querySelectorAll("#chatArea .msg");
      messages.forEach(m => {
        const text = m.innerText.toLowerCase();
        m.style.backgroundColor = text.includes(term) ? "#ffeb3b" : "";
      });
    }

    function closeSearch() {
      document.querySelector(".search-box").style.display = "none";
      document.getElementById("searchInput").value = "";
      const messages = document.querySelectorAll("#chatArea .msg");
      messages.forEach(m => m.style.backgroundColor = "");
    }

    // E-posta doƒürulama (3 saatte 1 kere)
    function resendVerification() {
      const user = auth.currentUser;
      const email = user.email;
      const last = localStorage.getItem("lastResend_" + email);
      const now = Date.now();
      if (last && now - last < 3 * 60 * 60 * 1000) {
        const left = Math.ceil((3 * 60 * 60 * 1000 - (now - last)) / 60000);
        showAlert("error", `${left} dakika sonra tekrar deneyin.`, "error");
        return;
      }
      user.sendEmailVerification().then(() => {
        localStorage.setItem("lastResend_" + email, now);
        startResendTimer();
        showAlert("success", "Doƒürulama maili g√∂nderildi.", "success");
      }).catch(e => showAlert("error", e.message, "error"));
    }

    function startResendTimer() {
      const email = document.getElementById("loginEmail").value || (auth.currentUser?.email);
      if (!email) return;
      const last = localStorage.getItem("lastResend_" + email);
      if (!last) return;
      const diff = 3 * 60 * 60 * 1000 - (Date.now() - last);
      if (diff > 0) {
        const mins = Math.ceil(diff / 60000);
        document.getElementById("resendTimer").innerText = ` (${mins} dk sonra)`;
        setTimeout(() => document.getElementById("resendTimer").innerText = "", diff);
      }
    }

    // ≈ûifreleme
    async function encrypt(text) {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const key = await crypto.subtle.importKey(
        "raw", encoder.encode("sohbetim-gizli-anahtar-32karakter!"), { name: "AES-GCM" }, false, ["encrypt"]
      );
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, data);
      return btoa(String.fromCharCode(...new Uint8Array(encrypted))) + "." + btoa(String.fromCharCode(...iv));
    }

    async function decrypt(encrypted) {
      try {
        const [dataB64, ivB64] = encrypted.split(".");
        const data = Uint8Array.from(atob(dataB64), c => c.charCodeAt(0));
        const iv = Uint8Array.from(atob(ivB64), c => c.charCodeAt(0));
        const key = await crypto.subtle.importKey(
          "raw", new TextEncoder().encode("sohbetim-gizli-anahtar-32karakter!"), { name: "AES-GCM" }, false, ["decrypt"]
        );
        const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
        return new TextDecoder().decode(decrypted);
      } catch { return "[≈ûifreli]"; }
    }
  </script>
</body>
</html>
