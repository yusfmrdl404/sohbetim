<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sohbetim - Gerçek Zamanlı Sohbet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="logo">
            <i class="fas fa-comments"></i>
            <h1>Sohbetim</h1>
            <p>Gerçek zamanlı, güvenli ve akıllı sohbet</p>
        </div>
        
        <div class="auth-container">
            <div class="auth-tabs">
                <button class="tab-btn active" data-tab="login">Giriş Yap</button>
                <button class="tab-btn" data-tab="register">Kayıt Ol</button>
            </div>
            
            <div class="auth-content">
                <!-- Giriş Ekranı -->
                <div class="tab-panel active" id="login-panel">
                    <form id="login-form">
                        <div class="input-group">
                            <i class="fas fa-envelope"></i>
                            <input type="email" placeholder="E-posta" required>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" placeholder="Şifre" required>
                        </div>
                        <div class="options">
                            <label>
                                <input type="checkbox"> Beni hatırla
                            </label>
                            <a href="#" class="forgot-password">Şifremi unuttum</a>
                        </div>
                        <button type="submit" class="auth-btn">Giriş Yap</button>
                        <button type="button" class="google-btn">
                            <i class="fab fa-google"></i> Google ile Giriş Yap
                        </button>
                    </form>
                </div>
                
                <!-- Kayıt Ekranı -->
                <div class="tab-panel" id="register-panel">
                    <form id="register-form">
                        <div class="input-group">
                            <i class="fas fa-user"></i>
                            <input type="text" placeholder="Kullanıcı Adı" required minlength="3" maxlength="20">
                        </div>
                        <div class="input-group">
                            <i class="fas fa-envelope"></i>
                            <input type="email" placeholder="E-posta" required>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" placeholder="Şifre" required minlength="6">
                        </div>
                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" placeholder="Şifreyi Onayla" required>
                        </div>
                        <div class="verification-info">
                            <p><i class="fas fa-info-circle"></i> Kayıt olduğunuzda e-posta adresinizi doğrulamanız gerekecek.</p>
                        </div>
                        <button type="submit" class="auth-btn">Hesap Oluştur</button>
                        <button type="button" class="google-btn">
                            <i class="fab fa-google"></i> Google ile Kayıt Ol
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="ai-assistant">
            <div class="assistant-icon">
                <i class="fas fa-robot"></i>
            </div>
            <div class="assistant-chat">
                <div class="chat-header">
                    <h3>AI Asistan</h3>
                    <span class="status active"><i class="fas fa-circle"></i> Çevrimiçi</span>
                </div>
                <div class="chat-messages">
                    <div class="chat-bubble ai">Merhaba! Size nasıl yardımcı olabilirim?</div>
                </div>
                <div class="chat-input">
                    <input type="text" placeholder="AI asistana sorun...">
                    <button><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Firebase Config -->
    <script>
        // Firebase yapılandırması
        const firebaseConfig = {
            apiKey: "AIzaSyCICiMDhK5MkQDq4dbV_9jkDMt4n3MUpEg",
            authDomain: "sohbetim-9a9d7.firebaseapp.com",
            databaseURL: "https://sohbetim-9a9d7-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "sohbetim-9a9d7",
            storageBucket: "sohbetim-9a9d7.firebasestorage.app",
            messagingSenderId: "277333150871",
            appId: "1:277333150871:web:d923f8cddb19ec2f672dd2"
        };

        // Firebase'i başlat
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
    </script>
    
    <!-- Uygulama Scripti -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Sekme geçişleri
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Aktif butonu güncelle
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Panel göster/gizle
                    const tabName = btn.getAttribute('data-tab');
                    tabPanels.forEach(panel => {
                        panel.classList.remove('active');
                        if (panel.id === `${tabName}-panel`) {
                            panel.classList.add('active');
                        }
                    });
                });
            });
            
            // Giriş formu
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = loginForm.querySelector('input[type="email"]').value;
                    const password = loginForm.querySelector('input[type="password"]').value;
                    
                    auth.signInWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            const user = userCredential.user;
                            
                            // E-posta doğrulama kontrolü
                            if (!user.emailVerified) {
                                alert('Lütfen e-posta adresinizi doğrulayın.');
                                auth.signOut();
                            } else {
                                // Kullanıcıyı sohbet sayfasına yönlendir
                                window.location.href = 'chat.html';
                            }
                        })
                        .catch((error) => {
                            let errorMessage = 'Giriş sırasında bir hata oluştu.';
                            
                            if (error.code === 'auth/wrong-password') {
                                errorMessage = 'Yanlış şifre!';
                            } else if (error.code === 'auth/user-not-found') {
                                errorMessage = 'Kullanıcı bulunamadı!';
                            } else if (error.code === 'auth/invalid-email') {
                                errorMessage = 'Geçersiz e-posta!';
                            }
                            
                            alert(errorMessage);
                        });
                });
                
                // Google ile giriş
                const googleLoginBtn = document.querySelector('.google-btn');
                if (googleLoginBtn) {
                    googleLoginBtn.addEventListener('click', () => {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        auth.signInWithPopup(provider)
                            .then((result) => {
                                const user = result.user;
                                
                                // Kullanıcı verilerini veritabanına kaydet
                                saveUserToDatabase(user, user.displayName || user.email.split('@')[0]);
                                
                                // Kullanıcıyı sohbet sayfasına yönlendir
                                window.location.href = 'chat.html';
                            })
                            .catch((error) => {
                                alert('Google ile giriş yapılamadı: ' + error.message);
                            });
                    });
                }
            }
            
            // Kayıt formu
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const username = registerForm.querySelector('input[type="text"]').value;
                    const email = registerForm.querySelector('input[type="email"]').value;
                    const password = registerForm.querySelector('input[type="password"]:first-of-type').value;
                    const confirmPassword = registerForm.querySelector('input[type="password"]:last-of-type').value;
                    
                    // Şifre doğrulama
                    if (password !== confirmPassword) {
                        alert('Şifreler eşleşmiyor!');
                        return;
                    }
                    
                    // Kullanıcı adı kontrolü
                    db.ref('usernames').once('value', (snapshot) => {
                        if (snapshot.hasChild(username)) {
                            alert('Bu kullanıcı adı zaten kullanımda!');
                            return;
                        }
                        
                        // Kullanıcı oluştur
                        auth.createUserWithEmailAndPassword(email, password)
                            .then((userCredential) => {
                                const user = userCredential.user;
                                
                                // E-posta doğrulama gönder
                                user.sendEmailVerification()
                                    .then(() => {
                                        alert('Kayıt başarılı! Lütfen e-posta adresinize gönderilen doğrulama linkine tıklayarak hesabınızı aktifleştirin.');
                                        
                                        // Kullanıcı verilerini veritabanına kaydet
                                        saveUserToDatabase(user, username);
                                        
                                        // Giriş ekranına yönlendir
                                        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                                        document.querySelector('[data-tab="login"]').classList.add('active');
                                        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                                        document.getElementById('login-panel').classList.add('active');
                                    });
                            })
                            .catch((error) => {
                                let errorMessage = 'Kayıt sırasında bir hata oluştu.';
                                
                                if (error.code === 'auth/email-already-in-use') {
                                    errorMessage = 'Bu e-posta adresi zaten kullanımda!';
                                } else if (error.code === 'auth/invalid-email') {
                                    errorMessage = 'Geçersiz e-posta!';
                                } else if (error.code === 'auth/weak-password') {
                                    errorMessage = 'Şifre çok zayıf! En az 6 karakter olmalı.';
                                }
                                
                                alert(errorMessage);
                            });
                    });
                });
            }
            
            // Kullanıcıyı veritabanına kaydet
            function saveUserToDatabase(user, username) {
                const userId = user.uid;
                
                // Kullanıcı adı kontrolü ve kaydı
                db.ref('usernames/' + username).set(userId)
                    .then(() => {
                        // Kullanıcı verilerini kaydet
                        db.ref('users/' + userId).set({
                            uid: userId,
                            email: user.email,
                            username: username,
                            displayName: username,
                            photoURL: `https://api.dicebear.com/7.x/initials/svg?seed=${username}`,
                            emailVerified: user.emailVerified,
                            provider: user.providerData[0].providerId,
                            lastLogin: firebase.database.ServerValue.TIMESTAMP,
                            status: 'online',
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        });
                        
                        // Aktif kullanıcı listesine ekle
                        db.ref('onlineUsers/' + userId).set({
                            lastSeen: firebase.database.ServerValue.TIMESTAMP,
                            status: 'online'
                        });
                    })
                    .catch((error) => {
                        console.error('Kullanıcı adı kaydedilemedi:', error);
                    });
            }
            
            // AI Asistan
            const assistantIcon = document.querySelector('.assistant-icon');
            const assistantChat = document.querySelector('.assistant-chat');
            const chatInput = document.querySelector('.chat-input input');
            const chatSendBtn = document.querySelector('.chat-input button');
            const chatMessages = document.querySelector('.chat-messages');
            
            if (assistantIcon && assistantChat) {
                assistantIcon.addEventListener('click', () => {
                    assistantChat.style.display = assistantChat.style.display === 'block' ? 'none' : 'block';
                });
                
                // Enter tuşu ile mesaj gönderme
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            handleAIChat();
                        }
                    });
                }
                
                // Gönder butonu
                if (chatSendBtn) {
                    chatSendBtn.addEventListener('click', handleAIChat);
                }
            }
            
            // AI Sohbet işleme
            function handleAIChat() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Kullanıcı mesajını ekle
                const userMessage = document.createElement('div');
                userMessage.className = 'chat-bubble user';
                userMessage.textContent = message;
                chatMessages.appendChild(userMessage);
                
                // Giriş alanını temizle
                chatInput.value = '';
                
                // En aşağı kaydır
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // AI Yanıtı (Groq API ile)
                getGroqResponse(message)
                    .then(response => {
                        const aiResponse = document.createElement('div');
                        aiResponse.className = 'chat-bubble ai';
                        aiResponse.textContent = response;
                        chatMessages.appendChild(aiResponse);
                        
                        // En aşağı kaydır
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    })
                    .catch(error => {
                        console.error("AI hatası:", error);
                        const aiResponse = document.createElement('div');
                        aiResponse.className = 'chat-bubble ai';
                        aiResponse.textContent = 'Üzgünüm, şu anda AI hizmeti kullanılamıyor.';
                        chatMessages.appendChild(aiResponse);
                        
                        // En aşağı kaydır
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    });
            }
            
            // Groq API ile AI Yanıtı Al
            async function getGroqResponse(message) {
                try {
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer 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'
                        },
                        body: JSON.stringify({
                            "model": "mixtral-8x7b-32768",
                            "messages": [
                                {
                                    "role": "system",
                                    "content": "Sen bir sohbet uygulaması asistanısın. Kullanıcıya yardımcı olacak şekilde cevap ver. Cevaplar Türkçe ve kısa olmalı."
                                },
                                {
                                    "role": "user",
                                    "content": message
                                }
                            ],
                            "temperature": 0.7,
                            "max_tokens": 512
                        })
                    });
                    
                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error("Groq API hatası:", error);
                    throw error;
                }
            }
            
            // Auth durumunu izle
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log("Kullanıcı giriş yaptı:", user.email);
                } else {
                    console.log("Kullanıcı çıkış yaptı");
                }
            });
        });
    </script>
</body>
</html>
